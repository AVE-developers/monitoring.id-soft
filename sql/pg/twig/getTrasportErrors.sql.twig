{% set tables = [
    {'tname':'archive',	'fldtime':'archive_dt',	'flderrormsg':'error_msg'},
    {'tname':'out',		'fldtime':'enqueue_dt',	'flderrormsg':'error_msg'},
    {'tname':'sent',	'fldtime':'dequeue_dt',	'flderrormsg':NULL},
    {'tname':'error',	'fldtime':'create_dt',	'flderrormsg':'error_msg'}
    ]
%}
{# set min_dt = {'year':2017,'month':7,'day':1} #}
WITH packets AS (
    {% for key, table in tables %}
    {% if key>0 %} UNION {% endif %} SELECT
                         substring ({{table.tname}}.file_name FROM '\_\d+\_(\d+)\_') :: INTEGER as ndoc,
                                                                                     '{{table.tname}}' :: VARCHAR (7) AS tname,
                                                                                                                      {{table.tname}}.id_instance :: SMALLINT AS idapt,
        {{table.tname}}.id :: INTEGER AS id,
        {{table.tname}}.{{table.fldtime}} :: TIMESTAMPTZ AS create_dt,
                                                         {{table.tname}}.enqueue_dt :: TIMESTAMPTZ AS enqueue_dt,
        {% if table.tname == 'out' %}
        'пакет поставлен в очередь на доставку в аптеку, аптека должна его забрать, если не забирает возможно проблемы связи'
        {% elseif table.tname == 'archive' %}
        'пакет обработан аптекой, но статус документа в 1С не изменен, ситуация не стандартная'
        {% elseif table.tname == 'sent' %}
        'пакет отправлен на аптеку, аптека должна вернуть ответ, если долго нет отета возможно проблемы связи'
        {% elseif table.flderrormsg %}{{table.tname}}.{{table.flderrormsg}}{% else %}NULL{% endif %}
        :: TEXT AS error_msg
        FROM
        repl.b2f_{{table.tname}} {{table.tname}}
        WHERE
        {{table.tname}}.enqueue_dt > make_date({{mddoc.year}}, {{mddoc.month}}, {{mddoc.day}}) :: TIMESTAMPTZ
                                                                                               AND {{table.tname}}.pack_type = 'IN_SUPP'
                                                                                               AND {{table.tname}}.id_b2f_bc IS NULL
                                                                                                                             AND {{table.tname}}.id_instance IN ({{idapts|join(',')}})
    {% endfor %}
)

SELECT
    packets.ndoc :: INTEGER                                             AS ndoc,
    packets.idapt :: SMALLINT                                           AS idapt,
    packets.tname :: VARCHAR(7)                                         AS tname,
    packets.id :: INTEGER                                               AS npack,

    extract(epoch from packets.create_dt at time zone 'UTC') :: BIGINT  AS data,
    extract(epoch from packets.enqueue_dt at time zone 'UTC') :: BIGINT AS enqueue,

    packets.error_msg :: TEXT                                                 AS msg,
    inactive.inactive_min :: SMALLINT                                   AS inactive
FROM
    packets

    INNER JOIN (
                   SELECT
                       ndoc      as ndoc,
                       MAX(packets.id) as mid
                   FROM
                       packets
                   WHERE packets.ndoc IN ({{ndocs|join(',')}})
                   GROUP BY
                       packets.ndoc) b
        ON packets.id = b.mid

    LEFT OUTER JOIN repl.fo_inactive_stat inactive
        ON packets.idapt = inactive.id_instance

WHERE packets.ndoc IN ({{ndocs|join(',')}})
ORDER BY packets.ndoc ASC
